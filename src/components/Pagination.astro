---
interface Props {
  lastPage: number;
  paramName?: string;
}

const { lastPage, paramName = "page" } = Astro.props;
---

<nav
	class="flex justify-center items-center gap-6 mt-12 py-8 font-medium"
	aria-label="Pagination"
	data-last-page={lastPage}
	data-param-name={paramName}
>
	{
		lastPage > 1 ? (
			<a href="/" class="text-gray-light cursor-not-allowed" data-pagination-prev>
				&larr; 前へ
			</a>
		) : (
			<span class="text-gray-light cursor-not-allowed">
				&larr; 前へ
			</span>
		)
	}

	<span class="text-gray-dark" data-pagination-label>1 / {lastPage}</span>

	{
		lastPage > 1 ? (
			<a href={`/?${paramName}=2`} class="text-accent hover:text-accent-dark transition-colors duration-200" data-pagination-next>
				次へ &rarr;
			</a>
		) : (
			<span class="text-gray-light cursor-not-allowed">
				次へ &rarr;
			</span>
		)
	}
</nav>

<script is:inline>
  (() => {
    const pipe =
      (...fns) =>
      (x) =>
        fns.reduce((v, f) => f(v), x);

    const clamp = (min, max) => (n) => Math.min(Math.max(min, n), max);
    const toNumberOr = (fallback) => (v) => {
      const n = Number(v);
      return Number.isFinite(n) ? n : fallback;
    };
    const getAttr = (el, name, fallback) => el?.getAttribute?.(name) ?? fallback;

    const getContext = () => {
      const script = document.currentScript;
      if (!script) return null;

      const section = script.closest("section[data-page-size][data-last-page]");
      const root = section ?? document;
      const nav = root.querySelector('nav[aria-label="Pagination"][data-last-page]');
      if (!nav) return null;

      return { script, section, root, nav };
    };

    const readModel = (ctx) => {
      const lastPage = toNumberOr(1)(getAttr(ctx.nav, "data-last-page", "1"));
      const paramName = getAttr(ctx.nav, "data-param-name", "page");

      const search = new URLSearchParams(window.location.search);
      const raw = toNumberOr(1)(search.get(paramName) ?? "1");
      const currentPage = clamp(1, lastPage)(raw);

      return { ...ctx, lastPage, paramName, search, currentPage };
    };

    const buildUrl = ({ paramName }) => (page) => {
      if (page <= 1) return "/";
      const u = new URL(window.location.href);
      u.searchParams.set(paramName, String(page));
      return u.pathname + "?" + u.searchParams.toString();
    };

    const setText = (el, text) => (el ? (el.textContent = text) : undefined);
    const setHref = (el, href) => (el ? el.setAttribute("href", href) : undefined);
    const removeHref = (el) => (el ? el.removeAttribute("href") : undefined);
    const setClass = (el, className) => (el ? (el.className = className) : undefined);

    const activeLinkClass = "text-accent hover:text-accent-dark transition-colors duration-200";
    const disabledLinkClass = "text-gray-light cursor-not-allowed";

    const renderList = (m) => {
      const items = Array.from(m.root.querySelectorAll("[data-post-list] > li[data-page]"));
      if (items.length === 0) return m;

      items.forEach((el) => {
        const page = toNumberOr(1)(getAttr(el, "data-page", "1"));
        el.classList.toggle("hidden", page !== m.currentPage);
      });

      return m;
    };

    const renderLabel = (m) => {
      const label = m.nav.querySelector("[data-pagination-label]");
      setText(label, `${m.currentPage} / ${m.lastPage}`);
      return m;
    };

    const renderLinks = (m) => {
      const prev = m.nav.querySelector("[data-pagination-prev]");
      const next = m.nav.querySelector("[data-pagination-next]");
      const urlOf = buildUrl(m);

      const prevState =
        m.currentPage > 1
          ? { href: urlOf(m.currentPage - 1), className: activeLinkClass }
          : { href: null, className: disabledLinkClass };

      const nextState =
        m.currentPage < m.lastPage
          ? { href: urlOf(m.currentPage + 1), className: activeLinkClass }
          : { href: null, className: disabledLinkClass };

      prevState.href ? setHref(prev, prevState.href) : removeHref(prev);
      setClass(prev, prevState.className);

      nextState.href ? setHref(next, nextState.href) : removeHref(next);
      setClass(next, nextState.className);

      return m;
    };

    const normalizeUrl = (m) => {
      if (!(m.currentPage === 1 && m.search.has(m.paramName))) return m;
      const u = new URL(window.location.href);
      u.searchParams.delete(m.paramName);
      const qs = u.searchParams.toString();
      window.history.replaceState(null, "", u.pathname + (qs ? `?${qs}` : ""));
      return m;
    };

    const ctx = getContext();
    if (!ctx) return;

    pipe(readModel, renderList, renderLabel, renderLinks, normalizeUrl)(ctx);
  })();
</script>

